<!doctype html>
<html lang="pt-BR">
 <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Reagendamento" />
    <meta name="author" content="Alex Lima, Gustavo Matos, Bianca Marques">
    <link rel="shortcut icon" href="img/OIP.jpg" type="image/png">

<title>Reagendamento Ausentes</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root {
    --bg-deep: #050505;
    --bg-panel: #0a0a0a;
    --primary: #00f2ff;
    --primary-dim: rgba(0, 242, 255, 0.08);
    --warning: #ff5500;
    --text-main: #ffffff;
    --text-muted: #888888;
    --border: #2a2a2a;
    --font-stack: 'Inter', system-ui, -apple-system, sans-serif;
    --glow: 0 0 15px rgba(0, 242, 255, 0.2);
    --glow-warn: 0 0 15px rgba(255, 85, 0, 0.3);
  }

  * { box-sizing: border-box; outline: none; }
  body { margin: 0; min-height: 100vh; font-family: var(--font-stack); background-color: var(--bg-deep); background-image: radial-gradient(circle at 50% -10%, #102030 0%, var(--bg-deep) 50%); color: var(--text-main); display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
  .app-container { width: 100%; max-width: 950px; padding: 40px 20px; display: flex; flex-direction: column; gap: 30px; z-index: 1; }
  .header { text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 12px; }
  .logo-dot { width: 14px; height: 14px; border-radius: 50%; background: linear-gradient(135deg, var(--warning), var(--primary)); box-shadow: var(--glow); }
  h1 { font-size: 20px; font-weight: 600; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; text-shadow: 0 0 20px rgba(0,0,0,0.5); }

  .header img { width: 36px; height: 36px; object-fit: contain; border-radius: 6px; }

  .dropzone { border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px; height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s ease all; background: rgba(255,255,255,0.02); cursor: pointer; position: relative; overflow: hidden; }
  .dropzone:hover, .dropzone.drag-active { border-color: var(--primary); background: var(--primary-dim); box-shadow: inset 0 0 30px rgba(0, 242, 255, 0.05); }
  .icon-file { font-size: 36px; margin-bottom: 12px; opacity: 0.7; animation: float 2.5s ease-in-out infinite; }
  @keyframes float { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-4px);} }
  .drop-text { font-size: 14px; color: var(--text-muted); text-align:center; }

  .filters { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
  .pill-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 24px; border-radius: 50px; font-size: 13px; font-weight: 600; letter-spacing: 0.5px; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
  .pill-btn:hover { border-color: var(--text-main); color: var(--text-main); }
  .pill-btn.active { background: rgba(255,255,255,0.08); border-color: var(--primary); color: #fff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); }

  .actions-bar { display: none; justify-content: flex-end; gap: 10px; margin-bottom: 10px; }
  .action-btn { background: var(--bg-panel); border: 1px solid var(--border); color: #fff; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: 0.2s; }
  .action-btn:hover { border-color: var(--primary); color: var(--primary); box-shadow: var(--glow); }
  .btn-reset { border-color: #552222; color: #ff8888; }
  .btn-reset:hover { border-color: #ff4444; color: #ff4444; box-shadow: 0 0 10px rgba(255,50,50,0.2); }

  .results-area { min-height: 100px; }
  .empty-msg { text-align: center; color: var(--warning); font-size: 14px; margin-top: 40px; opacity: 0.8; text-shadow: 0 0 10px rgba(255, 85, 0, 0.2); }
  .group-block { margin-bottom: 30px; animation: fadeIn 0.4s ease forwards; }
  .group-header { font-size: 12px; color: var(--primary); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; display: inline-block; }
  .list-item { display: flex; align-items: center; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.04); color: #eee; transition: 0.2s; background: linear-gradient(90deg, transparent, transparent); border-radius: 4px; }
  .list-item:hover { background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); padding-left: 18px; }
  .list-item.warn-item { color: var(--warning); border-left: 2px solid var(--warning); }
  .list-item.warn-item .client-name { color: var(--warning); }
  .list-item.warn-item .client-subject { color: rgba(255, 85, 0, 0.7); }
  .client-name { font-weight: 700; margin-right: 10px; min-width: 150px; }
  .client-subject { opacity: 0.7; font-weight: 300; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .footer-legend { position: fixed; bottom: 30px; right: 40px; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(4px); }
  .legend-row { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #ccc; }
  .box-legend { width: 12px; height: 12px; border-radius: 2px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @media(max-width:700px){ .footer-legend { position: static; margin-top: 30px; width: 100%; align-items: center; background: transparent; border: none; } .client-name { min-width: auto; } .list-item { flex-direction: column; align-items: flex-start; gap: 4px; } }
</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <img src="img/OIP.jpg" alt="OIP" onerror="this.style.display='none'">
    <div class=""></div>
    <h1>Filtro de Reagendamento</h1>
  </div>

  <div id="dropzone" class="dropzone">
    <div class="icon-file">ðŸ“„</div>
    <div class="drop-text">Arraste e solte o arquivo Excel aqui ou clique para selecionar</div>
    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
  </div>

  <div class="filters">
    <button class="pill-btn active" data-target="SBC">SBC</button>
    <button class="pill-btn" data-target="GRAJAÃš">GRAJAÃš</button>
    <button class="pill-btn" data-target="FRANCO">FRANCO</button>
  </div>

  <div class="actions-bar" id="actionsBar">
    <button class="action-btn" id="btnCopyAll">Copiar Tudo </button>
    <button class="action-btn btn-reset" id="btnReset">Limpar</button>
  </div>

  <div id="results" class="results-area">
    <div class="empty-msg">Aguardando arquivo...</div>
  </div>
</div>

<div class="footer-legend">
  <div class="legend-row">
    <div class="box-legend" style="background: #fff;"></div>
    <span>Reagendamento / Ausente</span>
  </div>
  <div class="legend-row">
    <div class="box-legend" style="background: var(--warning); box-shadow: var(--glow-warn);"></div>
    <span>EndereÃ§o nÃ£o localizado</span>
  </div>
</div>

<script>
(() => {
  const DIAG_REAGENDADO_PELO_CLIENTE = "REAGENDADO PELO CLIENTE";
  const DIAG_REAGENDADO_DEVIDO_HORARIO = "REAGENDADO DEVIDO HORARIO";
  const DIAG_CLIENTE_AUSENTE = "CLIENTE AUSENTE";
  const DIAG_ENDERECO_NAO_LOCALIZADO = "ENDEREÃ‡O NÃƒO LOCALIZADO";

  const DIAGS = [
    DIAG_REAGENDADO_PELO_CLIENTE,
    DIAG_REAGENDADO_DEVIDO_HORARIO,
    DIAG_CLIENTE_AUSENTE,
    DIAG_ENDERECO_NAO_LOCALIZADO
  ];

  const REGION_MAP = {
    "SBC": ["SBC","REDES SBC"],
    "GRAJAÃš": ["GRAJA","GRAJAÃš","GRAJAU"],
    "FRANCO": ["FRANCO","FRANCO DA ROCHA"],
    "SP": ["SP","21 -","23 -"]
  };

  const KEYWORDS = {
    [DIAG_ENDERECO_NAO_LOCALIZADO]: ["ENDERECO NAO LOCALIZADO","ENDERECO NAO ENCONTRADO","NAO LOCALIZADO","NAO ENCONTRADO","NÃƒO LOCALIZADO","NÃƒO ENCONTRADO"],
    [DIAG_CLIENTE_AUSENTE]: ["CLIENTE AUSENTE","AUSENTE","NAO ATENDEU","NÃƒO ATENDEU"],
    [DIAG_REAGENDADO_DEVIDO_HORARIO]: ["REAGENDADO DEVIDO HORARIO","REAGENDADO DEVIDO HORÃRIO","MUDOU HORARIO","MUDOU HORÃRIO","TROCA DE HORARIO","TROCA DE HORÃRIO"],
    [DIAG_REAGENDADO_PELO_CLIENTE]: ["REAGENDADO PELO CLIENTE","PELO CLIENTE","PEDIDO DO CLIENTE","CLIENTE SOLICITOU"]
  };

  let loadedData = [];
  let currentRegion = "SBC";

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const resultsDiv = document.getElementById('results');
  const actionsBar = document.getElementById('actionsBar');
  const regionBtns = document.querySelectorAll('.pill-btn');
  const btnCopyAll = document.getElementById('btnCopyAll');
  const btnReset = document.getElementById('btnReset');

  function normalizeStr(s) {
    if (s === null || s === undefined) return "";
    return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
  }

  function findKey(keys, substr) {
    const ns = normalizeStr(substr);
    return keys.find(k => normalizeStr(k).includes(ns));
  }

  function detectStrictDiagnosis(row) {
    const keys = Object.keys(row);
    const diagKey = keys.find(k => normalizeStr(k).includes("DIAGNOSTICO") || normalizeStr(k).includes("DIAGNÃ“STICO"));
    if (diagKey) {
      const val = normalizeStr(row[diagKey] || "");
      if (val) {
        if (val.includes(normalizeStr(DIAG_REAGENDADO_PELO_CLIENTE))) return DIAG_REAGENDADO_PELO_CLIENTE;
        if (val.includes(normalizeStr(DIAG_REAGENDADO_DEVIDO_HORARIO))) return DIAG_REAGENDADO_DEVIDO_HORARIO;
        if (val.includes(normalizeStr(DIAG_CLIENTE_AUSENTE))) return DIAG_CLIENTE_AUSENTE;
        if (val.includes(normalizeStr(DIAG_ENDERECO_NAO_LOCALIZADO))) return DIAG_ENDERECO_NAO_LOCALIZADO;
        return null; 
      }
    }

    const assuntoKey = findKey(keys, "ASSUNTO");
    const msgKey = findKey(keys, "MENSAGEM") || findKey(keys, "MESSAGE");
    const assunto = assuntoKey ? normalizeStr(row[assuntoKey] || "") : "";
    const mensagem = msgKey ? normalizeStr(row[msgKey] || "") : "";
    const source = (assunto + " " + mensagem).trim();

    for (const kw of KEYWORDS[DIAG_ENDERECO_NAO_LOCALIZADO]) {
      if (source.includes(normalizeStr(kw))) return DIAG_ENDERECO_NAO_LOCALIZADO;
    }
    for (const kw of KEYWORDS[DIAG_CLIENTE_AUSENTE]) {
      if (source.includes(normalizeStr(kw))) return DIAG_CLIENTE_AUSENTE;
    }
    for (const kw of KEYWORDS[DIAG_REAGENDADO_DEVIDO_HORARIO]) {
      if (source.includes(normalizeStr(kw))) return DIAG_REAGENDADO_DEVIDO_HORARIO;
    }
    for (const kw of KEYWORDS[DIAG_REAGENDADO_PELO_CLIENTE]) {
      if (source.includes(normalizeStr(kw))) return DIAG_REAGENDADO_PELO_CLIENTE;
    }

    return null;
  }

  function detectRegion(row) {
    const keys = Object.keys(row);
    const setorKey = findKey(keys, "SETOR");
    const assuntoKey = findKey(keys, "ASSUNTO") || findKey(keys, "SUBJECT");
    const setor = setorKey ? normalizeStr(row[setorKey] || "") : "";
    if (setor) {
      for (const r of Object.keys(REGION_MAP)) {
        for (const term of REGION_MAP[r]) {
          if (setor.includes(normalizeStr(term))) return r;
        }
      }
    }
    const assunto = assuntoKey ? String(row[assuntoKey] || "").trim() : "";
    const m = assunto.match(/^(\d+)\s*-/);
    if (m) {
      const n = parseInt(m[1], 10);
      if (n === 1) return "SBC";
      if (n === 21 || n === 23) return "SP";
    }
    return "OUTROS";
  }

  function extractFields(row) {
    const keys = Object.keys(row);
    const clienteKey = keys.find(k => normalizeStr(k).includes("CLIENTE") || normalizeStr(k).includes("NOME") || normalizeStr(k).includes("NAME"));
    const assuntoKey = keys.find(k => normalizeStr(k).includes("ASSUNTO") || normalizeStr(k).includes("SUBJECT"));
    const cliente = clienteKey ? String(row[clienteKey] || "").trim() : "Cliente Desconhecido";
    let assunto = assuntoKey ? String(row[assuntoKey] || "").trim() : "";
    assunto = assunto.replace(/^\s*\d+\s*-\s*/, ""); 
    return { cliente, assunto };
  }

  function analyzeRow(row) {
    const diag = detectStrictDiagnosis(row);
    if (!diag) return null; 
    const { cliente, assunto } = extractFields(row);
    const region = detectRegion(row);
    const isWarning = diag === DIAG_ENDERECO_NAO_LOCALIZADO;
    return { cliente, assunto, region, diag, isWarning };
  }

  function processFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        if (!json || !json.length) { alert("Arquivo vazio."); return; }
        loadedData = json.map(analyzeRow).filter(Boolean);
        actionsBar.style.display = loadedData.length ? "flex" : "none";
        render(); 
      } catch (err) {
        console.error(err);
        alert("Erro ao ler arquivo. Verifique se Ã© um Excel (.xlsx) vÃ¡lido.");
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function render() {
    resultsDiv.innerHTML = "";
    const filtered = loadedData.filter(item => {
      if (currentRegion === "SBC") return item.region === "SBC";
      return item.region === currentRegion;
    });
    if (!filtered.length) {
      resultsDiv.innerHTML = `<div class="empty-msg">Nenhuma O.S Ausente em ${currentRegion}.</div>`;
      return;
    }

    const order = [DIAG_REAGENDADO_PELO_CLIENTE, DIAG_REAGENDADO_DEVIDO_HORARIO, DIAG_CLIENTE_AUSENTE, DIAG_ENDERECO_NAO_LOCALIZADO];

    order.forEach(cat => {
      const items = filtered.filter(i => i.diag === cat);
      if (!items.length) return; 
      const block = document.createElement('div');
      block.className = 'group-block';
      const header = document.createElement('div');
      header.className = 'group-header';
      header.textContent = cat;
      block.appendChild(header);
      items.forEach(it => {
        const el = document.createElement('div');
        el.className = 'list-item' + (it.isWarning ? ' warn-item' : '');
        el.innerHTML = `<span class="client-name">${escapeHtml(it.cliente)}</span><span class="client-subject">${escapeHtml(it.assunto)}</span>`;
        block.appendChild(el);
      });
      resultsDiv.appendChild(block);
    });
  }

  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function buildCopyAllText() {
    if (!loadedData.length) return "";
    const preferred = ["SBC","GRAJAÃš","FRANCO","SP","OUTROS"];
    const groups = {};
    loadedData.forEach(r => { groups[r.region] = groups[r.region] || []; groups[r.region].push(r); });
    const presentRegions = Object.keys(groups).filter(k => groups[k] && groups[k].length);
    presentRegions.sort((a,b) => {
      const ia = preferred.indexOf(a), ib = preferred.indexOf(b);
      if (ia === -1 && ib === -1) return a.localeCompare(b);
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    });

    const order = [DIAG_REAGENDADO_PELO_CLIENTE, DIAG_REAGENDADO_DEVIDO_HORARIO, DIAG_CLIENTE_AUSENTE, DIAG_ENDERECO_NAO_LOCALIZADO];
    let out = "";
    presentRegions.forEach((reg, idx) => {
      out += `REAGENDAMENTO ${reg}\n\n`;
      order.forEach(cat => {
        const items = groups[reg].filter(i => i.diag === cat);
        if (!items.length) return;
        out += `${cat}:\n`;
        items.forEach(it => { out += `${it.cliente} - ${it.assunto}\n`; });
        out += `\n`;
      });
      if (idx !== presentRegions.length - 1) out += `-------------------\n\n`;
    });
    return out.trim();
  }

  async function copyAllHandler() {
    const text = buildCopyAllText();
    if (!text) return alert("Nada para copiar.");
    try {
      await navigator.clipboard.writeText(text);
      alert("Copiado!");
    } catch (e) {
      alert("Erro ao copiar.");
    }
  }

  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => { if (e.target.files[0]) processFile(e.target.files[0]); fileInput.value = ""; });
  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag-active'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-active'));
  dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('drag-active'); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); });

  regionBtns.forEach(btn => btn.addEventListener('click', () => {
    regionBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentRegion = btn.dataset.target;
    render();
  }));

  btnCopyAll.addEventListener('click', copyAllHandler);

  btnReset.addEventListener('click', () => {
    loadedData = [];
    resultsDiv.innerHTML = `<div class="empty-msg">Aguardando arquivo...</div>`;
    actionsBar.style.display = 'none';
  });

})();
</script>
</body>
</html>




